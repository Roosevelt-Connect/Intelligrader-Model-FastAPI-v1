name: Status Check

on:
  workflow_run:
    workflows: ["CI-CD Deployment Pipeline"]
    types:
      - completed

jobs:
  status-check:
    runs-on: self-hosted
    
    steps:
      - name: Check Service Endpoints
        env:
          HOST_IP: ${{ secrets.HOST_IP }}
        run: |
          # List of endpoints to check (add/remove as needed)
          endpoints=("/health")
          
          errorCount=0
          
          # Loop through each endpoint
          for endpoint in "${endpoints[@]}"; do
            endpoint_to_check="${HOST_IP}${endpoint}"
            echo "Checking endpoint: ${endpoint_to_check}"
            
            # Check the endpoint
            if ! curl -f -s -o /dev/null -w "%{http_code}" --max-time 10 "${endpoint_to_check}" > /dev/null 2>&1; then
              echo "ERROR: Failed to reach ${endpoint_to_check}"
              errorCount=$((errorCount + 1))
            else
              echo "SUCCESS: ${endpoint_to_check} is reachable"
            fi
          done
          
          # If any errors occurred, fail the job
          if [ $errorCount -ge 1 ]; then
            echo "Status check failed: ${errorCount} endpoint(s) unreachable"
            exit 1
          else
            echo "All endpoints are reachable"
            exit 0
          fi
